# ──────────────────────────────────────────────────────────────
# docker-compose.prod-tls.yml — Production TLS via Let's Encrypt
#
# Use alongside the main docker-compose.yml:
#   COMPOSE_FILE=docker-compose.yml:docker-compose.prod-tls.yml
#
# This override:
#   1. Removes the dev tls-init service
#   2. Adds nginxproxy/acme-companion for automatic Let's Encrypt certs
#   3. Adds LETSENCRYPT_HOST to each service for auto-provisioning
#
# Prerequisites:
#   - Services must be reachable from the internet on ports 80/443
#   - DNS A records must point to this host for all VIRTUAL_HOSTs
# ──────────────────────────────────────────────────────────────

services:
  # ── Disable dev-only services ─────────────────────────────────
  # tls-init: Replace with no-op (nginx-proxy depends on it completing)
  tls-init:
    entrypoint: ["true"]
    restart: "no"

  escrow-contract-deploy:
    profiles:
      - never

  anvil:
    profiles:
      - never

  bootstrap:
    profiles:
      - never

  # ACME companion auto-provisions Let's Encrypt certs for each
  # service that sets LETSENCRYPT_HOST and LETSENCRYPT_EMAIL.
  # Works with jwilder/nginx-proxy out of the box.
  acme-companion:
    image: nginxproxy/acme-companion
    depends_on:
      nginx-proxy:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/certs:/etc/nginx/certs
      - ./docker/vhost.d:/etc/nginx/vhost.d
      - acme-html:/usr/share/nginx/html
    environment:
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL:-admin@hostr.cc}
      - NGINX_PROXY_CONTAINER=hostr-nginx-proxy-1
    restart: unless-stopped

  # nginx-proxy needs the html volume for ACME challenges
  nginx-proxy:
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./docker/certs:/etc/nginx/certs
      - ./docker/vhost.d:/etc/nginx/vhost.d
      - ./docker/nginx-proxy.conf:/etc/nginx/conf.d/zzz_upload.conf:ro
      - acme-html:/usr/share/nginx/html

  # ── Add LETSENCRYPT_HOST to each public-facing service ───────

  relay:
    environment:
      - LETSENCRYPT_HOST=relay.${DOMAIN}

  blossom:
    environment:
      - LETSENCRYPT_HOST=blossom.${DOMAIN}

  # lnbits1, lnbits2, albyhub1, albyhub2 are dev-only (profiles: local, test)
  # and do not run in staging/production.

  landing-page:
    environment:
      - LETSENCRYPT_HOST=landing.${DOMAIN}

  # Dart services don't need CA injection in prod — LE certs are
  # already in system trust stores.
  escrow:
    depends_on:
      nginx-proxy:
        condition: service_healthy
        restart: true
      escrow-contract-deploy:
        condition: service_completed_successfully
        required: false
      anvil:
        condition: service_healthy
        required: false
    volumes:
      - ./docker/data/escrow:/data:ro
    command:
      [
        "sh",
        "-lc",
        "set -euo pipefail && export CONTRACT_ADDR=$$(cat /data/contract_addr) && exec dart run lib/cli.dart start",
      ]

  seed-relay:
    volumes:
      - ./:/workspace
    command: >
      bash -lc "dart pub get &&
      dart run bin/seed.dart
      --config-json='{\"relayUrl\":\"wss://relay.${DOMAIN}\",\"rpcUrl\":\"http://anvil:8545\",\"fundProfiles\":false}'"

volumes:
  acme-html:
