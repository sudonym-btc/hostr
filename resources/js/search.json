[[{"l":"Hostr","p":["semantic-release: angular","Rental accommodation using purely peer‑to‑peer technologies such as Nostr.","Read docs in full here.","This repo contains","Client README","Infrastructure README","Escrow README","Accommodation NIP","Escrow NIP"]},{"l":"NIPs utilized","p":["NIP-01: Basic protocol for event creation and subscription.","NIP-04: Encrypted direct messages for secure communication between hosts and guests. (Deprecated)","NIP-17: Private Direct Messages","NIP-05: Mapping Nostr keys to DNS-based internet identifiers.","NIP-09: Event deletion for removing listings or messages.","NIP-33: Parameterized replaceable events for creating and updating listings and bookings."]},{"l":"Clone","p":["Quickstart: see the client app guide at app/README.md for run targets by environment."]},{"l":"TODO"},{"l":"App","p":["Background worker: https://docs.page/fluttercommunity/flutter_workmanager/quickstart","Blossom files","Blossom server infrastructure","Broadcast preferred user blossom servers if not found","Broadcast preferred user escrows if not found","Broadcast preferred user relays if not found","Caching of blossom servers between Image components","Check if can NWC allows fetching invoice with description","Combine rootstock status check and NWC status check into one PaymentStatus","Display public / private keys","Escrow","Escrow advertisement events should allow for multiple services in one advertisement event","Event validation - async?","Form Image Input","Form Location Input","Image component which loads pubkeys blossom servers and generates file path","Language file","Mock lightning payments should 'resolve' accurate invoices and amounts","Mock NWC should record \"paid\" invoices and respond to list invoice request appropriately","Must show notifications for items not already in thread messaege sync hydrated cubit","NIP 05 verification","P1","P2","Payment flow in one \"snackbar\" instead of repeated popups","Payment status","Reservation Requests","Rif-relay mocking","Scan for NWC https://github.com/benthecarman/nips/blob/nostr-wallet-connect-connect/67.md","Settings","Startup loading page","State management","Sync giftwraps","Tests","Update Nip01Events in EntityCubit / ListCubits if they are updated","Update relays","Update trusted escrows","User trust escrow event broadcast"]},{"l":"Escrow","p":["Update escrow advertisement on launch","Listen for cancelled events and arbitrate accordingly","Must be able to read conversation once escrow is included"]}],[{"l":"Hostr","p":["semantic-release: angular","Rental accommodation using purely peer‑to‑peer technologies such as Nostr.","Read docs in full here.","This repo contains","Client README","Infrastructure README","Escrow README","Accommodation NIP","Escrow NIP"]},{"l":"NIPs utilized","p":["NIP-01: Basic protocol for event creation and subscription.","NIP-04: Encrypted direct messages for secure communication between hosts and guests. (Deprecated)","NIP-17: Private Direct Messages","NIP-05: Mapping Nostr keys to DNS-based internet identifiers.","NIP-09: Event deletion for removing listings or messages.","NIP-33: Parameterized replaceable events for creating and updating listings and bookings."]},{"l":"Clone","p":["Quickstart: see the client app guide at app/README.md for run targets by environment."]},{"l":"TODO"},{"l":"App","p":["Background worker: https://docs.page/fluttercommunity/flutter_workmanager/quickstart","Blossom files","Blossom server infrastructure","Broadcast preferred user blossom servers if not found","Broadcast preferred user escrows if not found","Broadcast preferred user relays if not found","Caching of blossom servers between Image components","Check if can NWC allows fetching invoice with description","Combine rootstock status check and NWC status check into one PaymentStatus","Display public / private keys","Escrow","Escrow advertisement events should allow for multiple services in one advertisement event","Event validation - async?","Form Image Input","Form Location Input","Image component which loads pubkeys blossom servers and generates file path","Language file","Mock lightning payments should 'resolve' accurate invoices and amounts","Mock NWC should record \"paid\" invoices and respond to list invoice request appropriately","Must show notifications for items not already in thread messaege sync hydrated cubit","NIP 05 verification","P1","P2","Payment flow in one \"snackbar\" instead of repeated popups","Payment status","Reservation Requests","Rif-relay mocking","Scan for NWC https://github.com/benthecarman/nips/blob/nostr-wallet-connect-connect/67.md","Settings","Startup loading page","State management","Sync giftwraps","Tests","Update Nip01Events in EntityCubit / ListCubits if they are updated","Update relays","Update trusted escrows","User trust escrow event broadcast"]},{"l":"Escrow","p":["Update escrow advertisement on launch","Listen for cancelled events and arbitrate accordingly","Must be able to read conversation once escrow is included"]}],[{"l":"App","p":["codecov","This is a client that displays and posts events related to short term accommodation lets over the nostr network."]},{"l":"Getting Started","p":["Install Flutter By default flutter launches in mock mode. It will not attempt to connect to relays or swap services. To connect to other environments, check the VSCode debug launcher."]},{"l":"Structure"},{"l":"NIPs Utilized","p":["NIP-01: Basic protocol for event creation and subscription.","NIP-05: Mapping Nostr keys to DNS-based internet identifiers.","NIP-09: Event deletion for removing listings or messages.","NIP-17: Encrypted direct messages for secure communication between hosts and guests.","NIP-33: Parameterized replaceable events for creating and updating listings and bookings."]},{"l":"Dependency injection and mocking","p":["Each Screen widget just handles the mapping of query and path parameters onto it's corresponding View widget. This allows for catalogging widgets while only using their TypeSafe parameters, rather than having to pass in query strings etc."]},{"l":"Improvements","p":["Swap in transaction should go straight into the contract","Escrow contract COULD encode bolt12, and then escrcow can do the swap by proving they paid a corresponding bolt11 invoice and releasing the funds to themselves. Out of scope. For now using LUD16 for zapReceipt."]},{"l":"Assets","p":["The assets directory houses images, fonts, and any other files you want to include with your application.","The assets/images directory contains resolution-aware images."]},{"l":"Localization","p":["This project generates localized messages based on arb files found in the lib/_localization directory.","To support additional languages, please visit the tutorial on Internationalizing Flutter apps"]}],[{"l":"Compile ABIs","p":["We use Boltz to swap into and out of escrow contracts on Rootstock's EVM L2.","To facilitate this, we require the ABIs that Boltz makes available for their swaps, and the ABIs used for the escrow contract.","If we import the ABIs, we can use web3dart package and it's accompanying class builder to easily interact with any EVM compatible L2. We only need to run this if there is a change in the ABIs, since the compiled dart is committed in the /app folder."]}],[{"l":"Screenshot","p":["To generate screenshots of the app run","Screenshots will be saved in app/screenshot."]}],[{"l":"List cubit","p":["A list cubit listens to a filter and starts a subscription stream instance with a specific filter. Emitting from the filter cubit will trigger the list state to reset. Use a postFilter cubit to emit a predicate that filters fetched results based on parameters that can't be filtered for via Nostr requests directly. A sort cubit determines how the results are ordered.","It has the following methods:","Load new","Load next","Load all","The class emits:"]},{"l":"Messaging cubit (Hydrated)","p":["The messaging cubit is responsible for loading and storing all kind 14 private and encrypted DMs. Since messages include reservation offers made & received, it's vital that this stays up-to-date and is synched upon app login. Since private DMs are sent using a random pubkey for added privacy, it is not possible to search for messages from/to our OWN pubkey to load relevant messages. Nostr NIP 17 recomemends giftwrapping the message and sending it from randomized keys to us and to the real receiver.","Before a user can interact in the inbox, the message stream must have received EOSE for all connected relays using filter","This stream, when completed, will hold a state of all messages ever received."]},{"l":"Search"},{"l":"Reservation Checker Cubit","p":["The reservation checker cubit can listen to the search list results, and query corresponding reservations as needed.","For each search result which matches the postResultFilter filter we need to fetch reservations to check availability. This is difficult, because one listing could have hundreds of reservations, or many listings could have no reservations. In the first iteration, we can just query each listing individually.","We could potentially load multiple listing's reservations using one NostrFilter by inputting multiple d tags.","For each result in our results list, we need to query all reservations as there is no way to filter based on date range.","Once each synch event fires, indicating that reservations have completely loaded for a set of listings, we need to update the search postResultFilter predicate to exclude those items, or reorder the list."]},{"l":"Reviews","p":["Reviews use Nostr kind 14. They can include tags such as tags: 'cleanliness', 1], ['checkIn', 0.6. The content can be the comment that the guest wishes to leave.","The review event should include a tag with commitment pre-image, that only the owner of the reservation knows,"]}],[{"l":"Search"}],[{"l":"State persistence"},{"l":"Hydrated cubits","p":["Hydrated blocs are used to persist state between app relaunched, preventing re-sync upon every usage. Hydrated blocs must be cleared on logout."]}],[{"l":"Swap in (Reverse Submarine Swap)","p":["A swap-in (reverse submarine swap) only happens when we are bridging to an EVM layer for escrow services. Once we are swapped in, the keys of our app (AKA the nsec) is the key for spending the funds into the escrow, and sweeping funds out of escrow upon completion."]}],[{"l":"Swap manager"},{"l":"Swap Manager (Hydrated)","p":["The swap manager is a global service that can run independently from UI (may need to be run in background) when possible.","Swap manager should be a hydrated cubit, such that it remembers the latest scanned part of the chain.","We need to make sure that if two instances of swap manager are running, they do not broadcast competing transactions. If they deterministically create the same transactions, should these be rejected by network and don't risk double-paying fees?","The swap manager might then be consumed like this"]}],[{"l":"Swap out (Submarine Swap)","p":["A swap-out occurs after an escrow has paid the seller out on the EVM chain. The funds now need to be swept back to lightning."]}],[{"l":"UI"},{"l":"Shared","p":["Accept","Attempt to fetch zaps to prove payment","Attempt to use EVM to check if money in lockup","Attempt to use lookup_invoice to check if invoices attached to reservation_requests have been paid","Calendar preloaded with unavailable dates","Can generate expiring invoice? Attach to listing","Can use NWC to generate expiring invoice.","Change","Combines with reservation list cubit where tag commit_hash is equal to first messages commit_hash tag","Conversation page","Counterparty name and avatar","Don't require upfront payment? Sends back signed reservation with commit_hash of buyers request","Edit page","Else display the message plaintext","Fetch reservation which references the anchor of this conversation.","Fetches each message in the conversation and unwraps/parses if necessary","For each item in the conversation","Header","Host","If guest mode:","If host","If host mode:","If null, fetch most recent reservation_request of this conversation anchor. \"Alex has requested to stay 3 night, Jan 3 - 6, for 60k sats\" or \"You offered to host Alex for 3 nights, Jan 3- 6, for 60k sats\" Accept (Change) - can change price if allowBarter is true, can change dates if counterparty is host.","If of message type:","If of reservation type:","If stay is in future: \"Alex is booked to be hosted by you Jan 3 - Jan 6\"","If wraps a reservation request display the offer widget","Image, name, description, NIP05, Zap button","Last message was a reservation request: 'Alex requested a 2 night stay'","List item","List of current in-flight payments","List of trusted escrow providers","Listing page","Look for reservation with commit_hash of reservation request, if exists, add \"booking confirmed\" icon to chat.","Messaging page","Profile page","Require upfront payment?","Reservation can be made instantly and for zero cost to block dates","Reserve button only active once all reservations are fetched and validated","Reviews and ratings, reservations, description, pricing","Show \"booking confirmed\" widget.","Show calendar by default","Show profile of counterparty","Shows current wallet connection, allows user to reconnect if required","Shows list of messages grouped by pubkey:a, identifies the conversation by user and reservation request anchor","Text of incoming or outgoing message, replaced with italic text if:","Wallet Page"]}],[{"l":"Conversation Page","p":["Conversations consist of wrapped messages between a seller and hoster, and contain direct messages and reservation requests.","A thread must reference a particular unique ID, primarily set by an initial ReservationRequest sent either by the host to the guest, or guest to the host."]}],[{"l":"Escrow","p":["We deposit using our EVM balance, usually after a swap in."]}],[{"l":"Payment","p":["A payment can be either a Bolt11 invoice, Bolt12 offer, LNURL string, Lightning Address, Zap, or npub. Unless a fixed user-requested amount has already been set, the flow should be as follows:","Payments requests, triggered by components in the app, should queue until they are next to be processed. Edge case."]},{"l":"Payments for swaps","p":["When we swap funds from lightning into EVM balance, the preimage from the swap invoice we paid is used to claw back the funds if something goes wrong. We also generate this preimage, so we must store this safely.","When we swap from EVM to lightning, we don't need receipt from lightning that payment was made. As we can just reclaim our EVM balance after a timeout if it has not been claimed. Movement of the EVM funds indicate success or failure."]},{"l":"Payments Manager / Ephemeral","p":["Consume payment requests visually"]}],[{"l":"Getting started","p":["Install dependencies: dnsmasq and route hostr.development to docker.","Launch all services to fully test app.","Power down.","Tear down.","Wipe the local relay.","Seed the relay.","Fund EVM balance:","docker exec into anvil"]}],[{"l":"State and DI Guide","p":["A quick decision helper for when to use GetIt singletons, global Bloc providers, feature cubits, or workflows in the Hostr app."]},{"l":"Decision cheatsheet","p":["Multi-step orchestration that talks to multiple services → Workflow","Shared service/client/cache with no UI state → Global singleton (GetIt)","App-wide UI/session state that many screens read → Global cubit (top-level BlocProvider)","Screen/feature-specific UI state → Feature cubit (route-level BlocProvider)"]},{"l":"Global singleton (GetIt)","p":["Use for stateless or long-lived services that sit below UI concerns.","Good fits: data sources (Nostr, LN, storage), domain services, repositories, HTTP/LN clients, relay connectors, caches, schedulers.","Traits: pure Dart, no Widget imports, no direct user interaction, safe to reuse across routes.","Provider: register once in app/lib/injection.dart; inject via constructors.","Avoid: storing UI state, depending on cubits, reaching into BuildContext."]},{"l":"Global cubit (BlocProvider at app root)","p":["Use when UI-facing state must persist for the whole app session and be readable across many routes.","Good fits: auth/session identity, app mode/env, wallet connectivity, globally cached streams (e.g., message stream cache), hydrated counts that improve UX.","Traits: exposes UI-ready state, may hydrate, may subscribe to services, rarely depends on other cubits.","Provider: set up in app root bootstrap; hydrate intentionally; keep side effects in services/workflows.","Avoid: housing heavy orchestration; calling other cubits; holding references to feature cubits."]},{"l":"Feature cubit (route/screen scope)","p":["Use for screen or flow-specific UI state that can be disposed when the route ends.","Good fits: form state, screen filters/sorts, one reservation flow, one swap flow, paging/selection state.","Traits: thin logic, delegates IO and complex steps to services/workflows; created via route-level providers or factories.","Avoid: holding global caches, cross-feature responsibilities, or long-lived streams better suited for services."]},{"l":"Workflow","p":["Use when an interaction is multi-step, touches multiple services, or needs progress/reporting.","Good fits: auth/login/signup, reservation booking, swaps, LNURL flows, event publishing, multi-step payments.","Traits: orchestrates service calls, sequences steps, maps errors, optionally drives cubits or returns a typed result; no widget imports.","Provider: injectable class constructed via GetIt; invoked from cubits or UI; report progress with ProgressSnapshot.","Avoid: storing long-lived UI state; emitting widgets; depending on BuildContext."]},{"l":"Patterns to keep","p":["Cubit → Service/Workflow → Data source. Avoid Cubit → Cubit calls.","Prefer constructor injection over runtime GetIt lookups inside widgets or cubits.","Hydrate only when it improves UX; otherwise keep state transient.","For architectural background and examples, see docs/architecture/ideal-architecture.md."]}],[{"l":"Infrastructure"},{"l":"Getting started","p":["You will need to have your domain registar use the Google Cloud DNS nameservers. After applying the Terraform config, you can go to the Google Cloud Console under Networks services > Cloud DNS. Find your domain name and get the DNS nameservers. Go to your domain registar and use all of the DNS nameservers (under the NS record like ns-cloud-b1.googledomains.com.)."]}],[{"l":"Tailscale & Split DNS for Local Development"},{"l":"Overview","p":["The local dev stack uses Tailscale to make services running on your dev Mac (via Docker) accessible from other devices — primarily an iPhone for real-device testing.","DNS resolution for *.hostr.development is handled by dnsmasq running on the dev Mac, with Tailscale providing the network path and split DNS routing for remote devices."]},{"l":"Architecture"},{"l":"DNS Resolution Paths"},{"l":"Dev Mac (fast, ~1ms)","p":["App/curl asks OS to resolve relay.hostr.development","macOS sees /etc/resolver/development → sends query to 127.0.0.1:53","Local dnsmasq answers immediately from its address= config","TCP connection to 100.95.205.9 goes over Tailscale for transport","Tailscale is only involved for transport, not DNS."]},{"l":"iPhone via Tailscale (slow cold start, ~6–20s)","p":["App asks OS to resolve relay.hostr.development","iOS tries its default DNS resolvers first (ISP/Wi-Fi/cellular)",".development is not a public TLD → NXDOMAIN or timeout","iOS eventually falls through to Tailscale's DNS proxy (100.100.100.100)","Tailscale sees the split DNS route → forwards to 100.95.205.9:53","dnsmasq answers in ~25ms","TCP/TLS connection via Tailscale tunnel","Total wall time: 6–20s (dominated by tunnel wake-up, not DNS)"]},{"l":"Simulator (fast, ~1ms)","p":["The iOS Simulator runs on the dev Mac and uses the Mac's resolver chain. Behaves identically to \"Dev Mac\" path above."]},{"l":"Other Mac on tailnet (depends on setup)","p":["With dnsmasq installed locally (/etc/resolver/development → 127.0.0.1): will fail completely if dnsmasq isn't running on that machine. Remove /etc/resolver/development to let Tailscale handle it.","Without /etc/resolver/development: uses Tailscale split DNS. Same behavior as iPhone but typically faster (macOS Tailscale daemon is less aggressively suspended than iOS Network Extension)."]},{"l":"Why the iPhone Cold Start is Slow","p":["~100–200ms","~25ms","~35ms","6–20s","After extended phone idle, it resets back to ~20s.","DERP relay bootstrap. Until Tailscale establishes a direct LAN path (hole-punching), traffic routes through a DERP relay server, adding latency.","dnsmasq query processing","First launch after long idle: ~20s","instant","iOS resolver + tunnel wake-up","iOS resolver fallback ordering. The system resolver tries default DNS servers before falling through to Tailscale's split DNS proxy.","iOS suspends the Tailscale Network Extension to save battery. When the app launches, the extension must wake up, re-establish the WireGuard tunnel, and negotiate a direct peer path.","Relay query execution","Second launch: ~11s","Segment","Tailscale LAN ping","The ~6–20s delay on first connect is not dnsmasq or relay performance. Benchmarks show:","The delay improves with repeated launches as Tailscale keeps more state warm:","The delay is caused by:","Third launch: ~6s","Time","TLS handshake","Warm tunnel: ~2–3s (floor = WireGuard rekey + TLS)","WebSocket upgrade"]},{"l":"Configuration"},{"l":"dnsmasq (on dev Mac)","p":["Config location: /opt/homebrew/etc/dnsmasq.conf","Active settings (appended at end of file):","Key points:","address=/.hostr.development/... — wildcard match for all *.hostr.development subdomains","listen-address includes the Tailscale IP so remote devices can query it","local-ttl=300 — 5-minute TTL so clients cache the response (was 0 by default, which prevented any caching)","log-facility=- — logs to system log (use log stream --predicate 'process == dnsmasq' to view)"]},{"l":"macOS resolver (on dev Mac only)","p":["/etc/resolver/development contains:","This is created by scripts/install.sh. It tells macOS to route all .development queries to local dnsmasq. Only needed on the machine running dnsmasq."]},{"l":"Tailscale admin console","p":["Split DNS route configured:","This tells all tailnet devices to forward *.hostr.development DNS queries to the dev Mac's dnsmasq."]},{"l":"iPhone","p":["Tailscale app installed with \"Connect on Demand\" enabled","No special DNS configuration needed — split DNS is pushed from the tailnet admin"]},{"l":"Troubleshooting"},{"l":"Other Mac can't resolve relay.hostr.development","p":["Most likely cause: /etc/resolver/development exists pointing to 127.0.0.1, but no dnsmasq is running locally."]},{"l":"Verify dnsmasq is working"},{"l":"Verify Tailscale split DNS"},{"l":"Verify end-to-end (bypassing DNS)"},{"l":"Watch DNS queries arrive at dnsmasq"},{"l":"Restart dnsmasq after config changes"},{"l":"Production Differences","p":["In production, none of this applies:","Relay runs on a public server with a real domain and valid TLS certificate","DNS is handled by a normal public DNS provider with standard TTLs","No Tailscale, no split DNS, no tunnel wake-up delay","Cold-start connect time will be dominated by TLS handshake (~100–200ms)","The slow iOS cold start is strictly a dev-environment constraint caused by the Tailscale VPN tunnel lifecycle on iOS."]},{"l":"Diagnostic Experiments"},{"l":"Experiment 1: Seed script broadcast isolate","p":["Hypothesis: The main Dart event loop is overloaded by hundreds of parallel EVM transactions during seeding, starving NDK's WebSocket.","Setup: Moved NDK event broadcasting into a dedicated Isolate with its own event loop (broadcast_isolate.dart). The isolate creates its own NDK instance, connects to the relay independently, and broadcasts events received via SendPort/ReceivePort.","Result: ✅ Every event broadcast succeeded on attempt #1 — zero retries. This proves the seed script failures were caused by event-loop starvation on the main isolate, not relay/DNS issues.","Fix: The seed pipeline now uses BroadcastIsolate permanently. See hostr_sdk/bin/seed/broadcast_isolate.dart."]},{"l":"Experiment 2: App cold-start relay probe isolate","p":["Hypothesis: If event-loop overload causes the seed script issue, maybe the same thing explains the ~6s cold-start delay in the Flutter app on iPhone.","Setup: Added a diagnostic isolate probe in setup.dart that spawns immediately after configureInjection. The isolate creates its own NDK instance in a completely separate event loop with zero contention — the main isolate does nothing (even runApp was removed, just a 100-second sleep).","Result: ❌ The probe isolate still took 6178ms to connect via NDK. Even with an empty main isolate and a dedicated event loop, the delay persists. This rules out event-loop overload as the cause for the app's cold-start delay.","Conclusion: The ~6s app cold-start delay on iPhone is confirmed to be a network-level issue (DNS resolution via Tailscale split DNS / tunnel wake-up), not Dart event-loop contention. NDK's 4s timeout fires because the underlying WebSocket connect is blocked waiting for DNS/tunnel, regardless of how idle the event loop is."]},{"l":"Summary","p":["Symptom","Root cause","Fix","Seed script broadcast failures","Main isolate event-loop starved by EVM txns","Broadcast isolate (permanent)","App cold-start ~6–20s on iPhone","iOS Tailscale tunnel wake-up + DNS","Dev-only; production uses public DNS"]}],[{"l":"Escrow","p":["Repo for listening to nostr events, running required L2 nodes and forwarding or reversing payments."]}],[{"l":"Hostr sdk"}],[{"l":"CHANGELOG"},{"l":"1.0.0","p":["Initial version."]}],[{"l":"Landing page"}],[{"l":"Privacy policy","p":["Your privacy policy here Use this to generate one for free: https://www.freeprivacypolicy.com/free-privacy-policy-generator.php"]}],[{"l":"Bundled H3 native binaries","p":["This folder vendors native H3 shared libraries for models when running outside Flutter (dart run)."]},{"l":"Why this exists","p":["Per h3_dart / h3_ffi docs, VM usage expects a native library loaded via H3Factory().byPath(...). The package does not publish universal prebuilt VM binaries for all platforms in one place; the recommended path is to build from source.","Source references:","https://pub.dev/packages/h3_dart","https://github.com/festelo/h3_dart/tree/master/h3_dart#setup","https://github.com/festelo/h3_dart/tree/master/h3_ffi#setup"]},{"l":"Bundled files","p":["macos/libh3.dylib","linux/libh3.so","windows/h3.dll","Optional architecture-specific variants are also supported:","macos/arm64/libh3.dylib","macos/x86_64/libh3.dylib","linux/arm64/libh3.so","linux/x86_64/libh3.so","windows/x86_64/h3.dll"]},{"l":"Runtime resolution","p":["H3Engine.bundled() resolves package root and loads the platform file above. If an architecture-specific file exists, it is preferred. If not, it falls back to the legacy platform path (for example linux/libh3.so).","Override path explicitly with env var:","HOSTR_H3_LIBRARY=/absolute/path/to/libh3.*"]},{"l":"Rebuilding binaries"},{"l":"macOS","p":["Build from h3_dart repository using scripts/build_h3.sh and copy h3_ffi/c/h3/build/lib/libh3.dylib."]},{"l":"Linux","p":["Build with Linux toolchain (native Linux or container) and copy libh3.so."]},{"l":"Windows","p":["Build with Windows toolchain (native Windows/MSVC/MinGW or cross-compile) and copy h3.dll."]}],[{"l":"Hostr App — Visual & Logic Audit","p":["Full audit of the Hostr Flutter app, hostr_sdk, and models layer. Date: 2026-02-23. No code changes — findings and execution plan only."]},{"l":"Table of Contents","p":["Execution Plan","L1. Error Handling","L2. Stream & Listener Lifecycle","L3. Caching, Batching & Use Cases","L4. Load & Performance Hotspots","L5. Nostr Protocol Future-Proofing","L6. Test Infrastructure & Automation","Part A — Visual","Part B — Logic","V1. Spacing & Padding","V2. Typography & Font Sizes","V3. Buttons — Types, Roles, Icons","V4. Icon Sizes","V5. Animations","V6. Modals & Bottom Sheets","V7. Image Loading & Placeholders","V8. Loading Indicators","V9. Translations / l10n"]},{"l":"Part A — Visual"},{"l":"V1. Spacing & Padding"},{"l":"Current State","p":["(non-standard — 3/16)","(non-standard — 5/16)","(non-standard)","~1","~12","~18","~20","~3","~5","~8","~9","1","1/2","1/4","1/8","1×","10","12","15","16","24","3/4","3/8","32","4","40","5/4","6","8","A kDefaultPadding = 32 constant exists in app/lib/config/constants.dart, and a CustomPadding widget wraps Padding with multipliers of kDefaultPadding. This is a good foundation, but ~75% of spacing in the app bypasses it.","Approx. uses","Equivalent kDefaultPadding fraction","Raw EdgeInsets with hardcoded values appear ~65 times across the presentation layer, duplicating values that CustomPadding already provides (e.g. EdgeInsets.symmetric(horizontal: 32) literally equals kDefaultPadding).","SizedBox hardcoded values found across presentation files:","That's 10 distinct spacing values, of which 3 (6, 10, 15) don't align to any clean fraction of the base grid.","Value (px)"]},{"l":"Recommendation","p":["Adopt a 4px base grid spacing scale (industry standard, used by Material 3):","Create a Spacer (or Gap) widget:","Then replace all SizedBox(height: 16) with Gap.md(), etc. This eliminates magic numbers and makes spacing auditable via search."]},{"l":"Files to Change (top offenders)","p":["presentation/component/widgets/reservation/trade_header.dart — 8+ SizedBoxes","presentation/component/widgets/flow/payment/payment.dart — 6+ SizedBoxes","presentation/component/widgets/inbox/thread/thread_header.dart — 5+ SizedBoxes","presentation/component/widgets/listing/listing_list_item.dart — 4 SizedBoxes","presentation/screens/shared/listing/listing_view.dart — mixed SizedBox + EdgeInsets","presentation/screens/shared/profile/ — multiple files"]},{"l":"V2. Typography & Font Sizes"},{"i":"current-state-1","l":"Current State","p":["11","12","14","16","20","24","28","bodyLarge (16) or titleSmall (14)","bodyMedium (14)","bodySmall (12)","Files","Hardcoded size","headlineMedium (28)","headlineSmall (24)","labelSmall (11)","price_marker.dart","price.dart","review_list_item.dart (star icon context)","Should be","The app uses Flutter's textTheme tokens in most places (good), but 7 distinct hardcoded fontSize values leak through:","titleLarge (22)","trade_header.dart","trade_header.dart, listing_list_item.dart, price_tag.dart, inbox_item.dart"]},{"l":"Best Practice — Type Scale","p":["11","12","14","16","22","24","45","Badges, chips, minimal annotations","Body","bodyMedium","bodySmall","Captions, timestamps, secondary info","Card titles, list item primary text","Descriptions, message text","Display","displayMedium","Headline","headlineSmall","Label","labelSmall","Material 3 defines exactly 15 text styles in 5 roles × 3 sizes. For a mobile accommodation app, you realistically need 5–7 distinct sizes to minimize cognitive load:","Role","Rule: Never use a raw fontSize: in widget code. Always use Theme.of(context).textTheme.bodySmall (with optional .copyWith(fontWeight: ...) for emphasis). This keeps the scale consistent and lets theme changes propagate everywhere.","Screen/section titles, form labels","Section headers on detail pages","Splash screen, hero numbers","Title","titleLarge","titleMedium","Token","Typical size","Use in Hostr"]},{"l":"Files to Change","p":["presentation/component/widgets/reservation/trade_header.dart — worst offender, 5 hardcoded sizes (11, 12, 14, 16)","presentation/component/widgets/listing/price_tag.dart — hardcoded 12","presentation/component/widgets/listing/price.dart — hardcoded 20","presentation/component/widgets/search/price_marker.dart — hardcoded 28","presentation/component/widgets/listing/listing_list_item.dart — hardcoded 12"]},{"l":"V3. Buttons — Types, Roles, Icons"},{"i":"current-state-2","l":"Current State","p":["~10","~2","~32","~7","~8","Cancel, clear, secondary actions","Count","CTAs, confirmations","ElevatedButton","FilledButton / .tonal / .icon","Four button types are used across the app:","IconButton","Navigation, copy, close","OutlinedButton","Primary use","Problem: ElevatedButton and FilledButton are used interchangeably for primary CTAs. The swap flow screens (swap_in.dart, swap_out.dart) and dev.dart use ElevatedButton, while everything else uses FilledButton. This creates a visual inconsistency — ElevatedButton has elevation/shadow, FilledButton is flat.","Swap flows, some CTAs","Tertiary/toggles","TextButton","Type"]},{"l":"Best Practice — Button Hierarchy","p":["✅ When the action has a universally recognized symbol (copy \uD83D\uDCCB, send ✈, close ✕)","✅ When used alongside other icon-only buttons in a row (toolbar)","❌ When the button already has clear text (\"Pay\" doesn't need a \uD83D\uDCB0 icon)","❌ When the icon is decorative rather than communicative","Always","Cancel, Clear, Skip — low-commitment actions","Delete, Refund, Block","Destructive","FilledButton","FilledButton + red backgroundColor","FilledButton.tonal","Icon for emphasis (⚠)","Icon-only","Icon?","IconButton","One per screen max. The main action (Pay, Reserve, Submit)","Only if icon adds clarity (e.g. send ✈, not generic ✓)","Optional","Primary CTA","Rarely","Role","Secondary","Supporting actions (Use Escrow, Edit)","Tertiary","TextButton","Toolbar actions, close, copy, navigation","When to use","When to use icons on buttons:","Widget"]},{"l":"Action Items","p":["Replace all ElevatedButton with FilledButton across swap_in.dart, swap_out.dart, dev.dart","Define button presets in theme (or a AppButton wrapper) so primary/secondary/destructive styling is centralized","Audit icon usage on FilledButton.icon — ensure icons are communicative, not decorative"]},{"l":"V4. Icon Sizes"},{"i":"current-state-3","l":"Current State","p":["10 distinct icon sizes are hardcoded across the app:","12","14","16","18","20","30","32","40","48","6+ files","80","Amount input","CircleAvatar fallback","Copy icon, comment","Default small icons","Detail actions","Detail view","Error icons","Field icons","Hero icon","Inline indicators","Key icon, chips","Multiple","Navigation","Profile","Role","Search nav","Section icons","Size","Standard interactive","Status","The same icon (Icons.copy) appears at sizes 12, 16, and 18 in different files.","Verified badge detail","Where"]},{"i":"recommendation-1","l":"Recommendation","p":["Define an icon size scale mirroring the spacing scale:","Standardize: all copy icons → kIconSm, all nav icons → kIconLg, etc."]},{"l":"V5. Animations"},{"i":"current-state-4","l":"Current State","p":["—","1000ms","1500ms","200ms","300ms (hardcoded)","400ms","Animation constants are well-defined in config/constants.dart:","Correct for shimmer","Curve","Curves.easeInOut","Curves.easeInOut (hardcoded)","Curves.easeOut","Debounce, not animation (OK)","Deviations:","Different curve","Duration","File","Issue","listing_carousel.dart","money_in_flight.dart","Non-standard duration","search_box.dart","Should reference constants","The AnimatedListItem widget correctly defaults to these. Most AnimatedSwitcher usages reference kAnimationDuration.","trade_header.dart (shimmer)","trade_timeline.dart"]},{"i":"recommendation-2","l":"Recommendation","p":["Replace hardcoded Duration(milliseconds: 300) in listing_carousel.dart with kAnimationDuration","Decide: is 400ms intentional for money_in_flight.dart? If not, use kAnimationDuration. If yes, define kAnimationDurationSlow = Duration(milliseconds: 400)","Consider adding kAnimationDurationFast = Duration(milliseconds: 150) for micro-interactions (button press feedback, chip toggles)","Standardize on one curve family. easeInOut is correct for most transitions. easeOut is appropriate for elements entering the screen (quick start, gentle stop)"]},{"l":"Preloading & Perceived Performance","p":["Can filter screens be preloaded? Yes — create the filter bottom sheet widget eagerly in the parent and show/hide it rather than constructing on tap. The SearchFilterCubit state should already be warm. In practice, if the bottom sheet construction is < 16ms (one frame), preloading isn't necessary. Profile first with DevTools timeline.","Preloading images / placeholders:","Currently BlossomImage shows CircularProgressIndicator while loading and Flutter's Placeholder() (a colored cross) on error — both are jarring","Add FadeInImage-style crossfade from a shimmer/skeleton placeholder to the loaded image","Consider adding precacheImage() calls for above-the-fold listing images when the list screen initializes","Implement CachedNetworkImage (or equivalent) to avoid re-downloading on every screen revisit"]},{"l":"V6. Modals & Bottom Sheets"},{"i":"current-state-5","l":"Current State","p":["15 showModalBottomSheet callsites exist. A ModalBottomSheet wrapper widget provides consistent internal layout. But:","Issue","Affected files","isScrollControlled inconsistently set","7 of 15 don't set it","useSafeArea only set in 1 of 15 callsites","All except listing_view.dart","Several callsites bypass ModalBottomSheet and build custom layouts","listing_view.dart, trade_header.dart, search_box.dart","No shared showAppModalBottomSheet() helper","Each callsite configures independently"]},{"i":"recommendation-3","l":"Recommendation","p":["Create a single entry point:","Then replace all 15 callsites. This ensures consistent isScrollControlled and useSafeArea defaults."]},{"l":"V7. Image Loading & Placeholders"},{"i":"current-state-6","l":"Current State","p":["BlossomImage is the standard image widget — resolves SHA-256 hashes via Blossom server, falls back to Image.network","No disk caching — no CachedNetworkImage or equivalent anywhere in the codebase","Error state shows Flutter's Placeholder() widget (a colored diagonal cross) — not production-ready","Loading state shows a raw CircularProgressIndicator","Some files bypass BlossomImage and use raw Image.network (relay favicons, badge images)"]},{"i":"recommendation-4","l":"Recommendation","p":["Add cached_network_image package — provides disk + memory caching, placeholder builders, and error builders out of the box","Replace Placeholder() with a branded error widget — e.g. a subtle grey rectangle with a broken-image icon","Replace loading CircularProgressIndicator with a shimmer skeleton matching the image's aspect ratio. This prevents layout shift when images load.","Wrap BlossomImage to use caching internally — so every BlossomImage benefits without changing callsites","Precache hero images — call precacheImage() for the first N listing images visible on the home/search screen"]},{"l":"V8. Loading Indicators"},{"i":"current-state-7","l":"Current State","p":["27 CircularProgressIndicator instances across the app with 4 different strokeWidth values (default ~4.0, 4, 2, 1.5). Additionally:","Some use .adaptive(), others don't","A custom AsymptoticProgressBar exists (nice!) but is used in only one place","A private _ShimmerSurface in trade_header.dart is not reusable"]},{"i":"recommendation-5","l":"Recommendation","p":["Create a shared AppLoadingIndicator widget with size presets:",".small() — strokeWidth: 2, 16x16, for inline/list contexts",".medium() — strokeWidth: 3, 24x24, default",".large() — strokeWidth: 4, 48x48, for full-page loading","Extract _ShimmerSurface into a reusable ShimmerPlaceholder widget","Create ShimmerListItem, ShimmerCard skeleton widgets for list/card loading states (prevents layout shift)","Use CircularProgressIndicator.adaptive() everywhere for platform-native feel on iOS"]},{"l":"V9. Translations / l10n"},{"i":"current-state-8","l":"Current State","p":["~51 strings use AppLocalizations.of(context)! (translated)","~70 strings are hardcoded English Text('...') literals (not translated)","Only English ARB file exists (app_en.arb with ~68 keys)","No pluralization rules, no parameterized messages beyond simple string interpolation","Hardcoded string hotspots:","dev.dart (debug screen — acceptable)","payment.dart, payment_method.dart — \"Pay directly\", \"Use Escrow\", \"Copy\", \"Open wallet\"","swap_in.dart, swap_out.dart — \"Confirm\", \"Continue\"","listing_view.dart — \"Blocked Dates\", \"Block Dates\", \"Retry\"","background_tasks.dart — all debug strings (acceptable)","edit_review.dart — \"Save\"","Various error messages — \"Error:\", \"Unknown message type\", \"No wallet connected\""]},{"i":"recommendation-6","l":"Recommendation","p":["Immediate: Extract all user-facing hardcoded strings to app_en.arb. Debug-only strings (dev.dart, background_tasks.dart) can stay hardcoded","Naming convention: Use camelCase keys matching the semantic role: payDirectly, useEscrow, blockedDates, retryButton, noWalletConnected","Error messages: Create parameterized ARB entries: errorGeneric: Something went wrong: {details} with @errorGeneric metadata for placeholders","Plurals: Add plural rules for counts: reviewCount: {count, plural, =0{No reviews} =1{1 review} other{{count} reviews}}","When ready for multi-language: add app_es.arb, app_fr.arb, etc. The Flutter l10n tooling will generate all delegates automatically"]},{"l":"Part B — Logic"},{"l":"L1. Error Handling"},{"l":"Current State — 5+ Inconsistent Patterns","p":["⚠️ Double-report","⚠️ dynamic type","⛔ Critical","✅ Best","Cubits","EntityCubit, ProfileCubit","EntityCubitStateError(dynamic error)","ListCubit, CountCubit","No error state at all","OK","OnboardingCubit, AvailabilityCubit","Pattern","PayOperation, SwapInOperation, EscrowFundOperation","ReservationCubit, ThreadReplyCubit","SDK operations with typed failure + rethrow","Sealed class with error subclass","Severity","Status enum + String? error field"]},{"l":"Critical Issues"},{"l":"1. ListCubit has NO error handling","p":["The next() method has a try/finally with no catch. The sync() subscription listener has no onError. This is the core data-fetching cubit — any relay failure crashes the stream silently."]},{"l":"2. CountCubit.count() has no try/catch","p":["CountCubitStateError is defined but never emitted — dead code. Exceptions from nostrService.requests.count() propagate unhandled."]},{"l":"3. PayOperation double-reports errors","p":["Each stage (resolve, finalize, complete) emits PayFailed AND rethrows the exception. If the caller also catches, the error surfaces twice. Additionally, complete() closes the cubit in a finally block — so PayFailed is emitted, then the cubit immediately closes, potentially causing a race condition in BlocBuilder."]},{"l":"4. Swap failures discard error details","p":["The UI renders SwapInFailed / SwapOutFailed as hardcoded Swap failed. strings, ignoring the error field that contains actionable information (e.g. \"insufficient inbound liquidity\", \"invoice expired\")."]},{"l":"5. No global error boundary","p":["runZonedGuarded only calls debugPrint. No crash reporting (Sentry, Crashlytics). No FlutterError.onError. No BlocObserver for cubit error monitoring."]},{"l":"6. Raw error strings shown to users","p":["PayFailed and auth errors show e.toString() directly in the UI — exposing internal stack traces, exception class names, or cryptic relay errors to users."]},{"l":"Recommendations","p":["Standardize on sealed error states. Every cubit should use:","Add try/catch to ListCubit.next() — emit an error state, enable retry","Wire up CountCubitStateError — emit it in the catch block","Remove rethrow from PayOperation — emit PayFailed only, don't rethrow. Let UI handle via BlocListener","Don't close the cubit in PayOperation.complete() on failure — let the UI decide when to dismiss","Map errors to user-friendly messages — create an ErrorMapper that converts known exceptions to localized strings. Unknown errors → generic \"Something went wrong. Please try again.\"","Add global BlocObserver for logging all cubit transitions and errors","Add Sentry/Crashlytics in runZonedGuarded and FlutterError.onError","Use BlocListener for transient error toasts — complement BlocBuilder error rendering with snackbar notifications for errors the user should know about but that don't replace the screen"]},{"l":"L2. Stream & Listener Lifecycle"},{"l":"Current State — ✅ Generally Well-Managed","p":["All cubits with subscriptions properly override close() and cancel subscriptions:","ThreadCubit — cancels all subs, closes participant cubits, deactivates trade","ListCubit — cancels 5 subscriptions, closes itemStream and nostr response","NwcConnectivityCubit — cancels connections subscription + per-cubit map","OnboardingCubit — cancels threads subscription, has reset()","All widgets with subscriptions cancel in dispose():","ListingListItemWidget — cancels reservation subscription, closes stream and cubits","SearchMapWidget — cancels list subscription","EscrowFundWidget — cancels selector subscription, closes operation and cubit"]},{"l":"Best Practice: _subscriptions list vs takeUntil vs individual fields","p":["Approach","When to use","Individual fields (_sub1, _sub2)","When you have 1–3 named subscriptions with distinct lifecycle","ListStreamSubscription _subscriptions","When subscriptions are dynamic or numerous (e.g. ThreadCubit)","takeUntil(dispose$) with RxDart","When using RxDart extensively and want declarative cleanup. Requires a PublishSubjectvoid _dispose$ that emits in close()","CompositeSubscription (RxDart)","Alternative to list — composite.add(stream.listen(...)), then composite.dispose()","The current codebase uses approach 1 and 2, which is fine. No change required unless you adopt RxDart more heavily."]},{"l":"One Risk Found","p":["ProfileCubit doesn't override close() and holds no subscriptions — but it's created dynamically by ThreadCubit which is responsible for closing it. This delegation pattern is correct but fragile: if any other code creates a ProfileCubit without closing it, it will leak. Consider documenting this ownership convention."]},{"l":"L3. Caching, Batching & Use Cases"},{"l":"CRUD UseCase Architecture","p":["_inFlightQueries keyed by serialized filter — identical concurrent queries share one stream","✅","❌","500ms debounce window, combines filters, matches results back to callers","500ms debounce, merges tag values into one relay query","Application-level cache","cacheRead: false — every getOne/list hits the relay","count() efficiency","CrudUseCaseT is the backbone. Key behaviors:","Feature","Fetches ALL events and calls .length — no relay-side COUNT support","findByTag batching","getOne batching","In-flight query dedup","Initial query uses cacheRead: true, live uses cacheWrite: true","NDK cache (one-shot query)","NDK cache (subscribe)","No in-memory or disk cache for domain objects","No retry logic anywhere in the SDK","Notes","Retry on failure","Status"]},{"l":"Caching Strategy Recommendations","p":["Enable cacheRead: true for query() — the NDK's MemCacheManager already supports this; flipping the flag would give free in-memory caching for repeated queries (e.g. viewing the same listing twice)","Add a TTL-based invalidation — cached items should expire after N minutes. Stale-while-revalidate pattern: return cached immediately, refetch in background, update if changed","Profile-level caching — user profiles (kind: 0) are fetched repeatedly; add a ProfileCache keyed by pubkey with a 5-minute TTL","Listing image caching — adopt cached_network_image for disk-level image caching (see V7)","Relay-side COUNT — NIP-45 defines COUNT messages. If your relays support it, implement a proper count() that doesn't download all events. The NDK may already support this — check Ndk.requests.count()"]},{"l":"Batching Tuning","p":["The 500ms debounce window is a trade-off:","Pro: Maximizes batching — more calls coalesce into fewer relay queries","Con: Adds 500ms latency to every first request in a batch window","Consider adaptive debounce: start at 50ms, extend to 500ms only when under high load (>5 pending requests). For UI-triggered fetches (user taps a listing), 50ms is imperceptible; for background syncs, 500ms is fine."]},{"l":"L4. Load & Performance Hotspots"},{"l":"\uD83D\uDD34 Critical"},{"l":"1. Subscription Explosion per Active Trade","p":["Each ThreadTrade opens 3–4 concurrent Nostr subscriptions (all reservations, filtered reservations, reviews, zaps, escrow events). A user with 10 active trades = 30–50 concurrent relay subscriptions. Most relays cap at 10–20 concurrent subscriptions and will start closing older ones.","Fix: Multiplex trade subscriptions. Instead of per-trade subscriptions, open ONE subscription per kind that covers all active trades using combined filters, then dispatch events to the appropriate trade in-memory."]},{"l":"2. N+1 Query in subscribeToMyReservations()","p":["For each reservation request message in the thread stream, a full getListingReservations() relay query fires. 20 messages = 20 queries.","Fix: Batch listing IDs from all messages, then fire a single findByTag query covering all listings at once."]},{"l":"3. count() Downloads Everything","p":["CrudUseCase.count() fetches all matching events and calls .toList().length. For listings with hundreds of reservations, this is hugely wasteful.","Fix: Implement NIP-45 COUNT if relays support it, or cache counts locally with invalidation on new events."]},{"l":"\uD83D\uDFE1 Moderate"},{"l":"4. Thread Rebuild on Every sync()","p":["Threads._rebuildThreadsFromMessages() clears all threads and re-processes every persisted message on each login. With 500+ messages, this is O(n) on startup.","Fix: Incremental thread updates — only process new messages since last sync timestamp."]},{"l":"5. Gift-wrap Fan-out","p":["Each DM creates N+1 gift-wraps (one per recipient + self). A message to 3 participants = 4 broadcasts. This is inherent to NIP-17 and can't be avoided, but it's worth monitoring."]},{"l":"6. No Query-level Caching for query()","p":["Since query() uses cacheRead: false, the same listing/metadata is fetched repeatedly when navigating between screens."]},{"l":"L5. Nostr Protocol Future-Proofing"},{"l":"Event Versioning — Currently None","p":["There is zero versioning infrastructure:","No version field in any event content JSON","No version tag on events","fromJson methods have no fallback for missing fields","Adding a required field to ListingContent would crash parsing of every existing listing on relays","Impact scenario: You add cancellationPolicy to ListingContent. Every old listing on relays fails to parse → fromJson throws → parser rethrows → stream crashes."]},{"i":"recommendations-1","l":"Recommendations"},{"l":"1. Add a Content Version Field","p":["Add v to all custom event content. Start at 1. Increment on breaking changes."]},{"l":"2. Make fromJson Tolerant","p":["Use json[field] ?? defaultValue for all fields. Amenities.fromJSON already does this correctly — propagate the pattern to ListingContent, ReservationContent, ReviewContent, etc."]},{"l":"3. Add a Version Tag to Events","p":["This allows relay-side filtering by version if needed, and lets clients ignore events they can't parse."]},{"l":"4. Implement a Migrator","p":["When the app starts, query for own events with outdated versions, re-sign with updated content, and republish. Since Nostr events are immutable (signed), migration requires publishing new replaceable events (same d-tag, newer created_at)."]},{"l":"5. Parser Error Resilience","p":["The parser currently rethrows on malformed events, crashing the entire stream. Change to:","Then filter nulls from the stream. This is critical for forward-compatibility — a newer client might publish events that an older client can't parse."]},{"l":"6. Kind Number Issue","p":["kNostrKindEscrowService = 40021 is in the ephemeral range (≥40000). Relays are not expected to store ephemeral events. Move to 30000–39999 range (parameterized replaceable)."]},{"l":"7. Tag Collision Risk","p":["Single-letter tags l, r, t, h may collide with future NIP standardizations (NIP-32 already uses l for labels). Options:","Formally propose these tag usages in a NIP","Switch to multi-character tags (e.g., listing, reservation)","Accept the collision risk and handle it in the parser by checking event.kind before interpreting tags"]},{"l":"Nostr Best Practices for Schema Evolution","p":["Replaceable events are your friend — same pubkey + kind + d-tag naturally supersedes old versions","Content is opaque to relays — you can change JSON structure freely; relays only index tags","Tags are the public API — treat tag names and semantics as stable; content JSON as internal","Backwards-compatible additions — new optional fields with defaults are always safe","Breaking changes — require a new kind number or a version tag that old clients can filter out"]},{"l":"L6. Test Infrastructure & Automation"},{"i":"current-state-9","l":"Current State","p":["_Fake* classes duplicated across SDK test files","⚠️","⚠️ Minimal","✅","✅ 11 files","✅ 3 files","❌","❌ Empty","❌ Nearly empty","1 screenshot test with 6 screens","App integration tests","App unit tests","App widget tests","Area","Directory scaffolded but no tests","Good coverage of core logic","No golden test comparison","Notes","Only 1 smoke test (2+3=5) and 1 cubit test","Real Docker stack, escrow + swap flows","SDK integration tests","SDK unit tests","Shared test helpers","Status","Visual regression","Well-structured, multi-device frames","Widgetbook"]},{"l":"Seed Data Architecture — Two Systems","p":["System 1: Static Stubs (models/lib/stubs/) — Hardcoded mock data with 3 fixed keypairs. Used for Env.mock quick startup.","System 2: SeedPipeline (hostr_sdk/lib/seed/) — Sophisticated deterministic seed generation with configurable user count, host ratio, thread progression stages, per-user overrides. This is excellent but only used in SDK tests, not in app integration tests."]},{"l":"What's Missing for Desired Workflows"},{"l":"Flutter Drive to Specific Pages","p":["The current integration test uses appRouter.navigate() which works but requires full app bootstrap. For surgical page testing:","Create a TestScenario class:","Define scenarios:","Run per-scenario: flutter test integration_test/scenarios/host_with_bookings_test.dart"]},{"l":"App Store Screenshot Pipeline","p":["Device matrix: Run against multiple simulators/emulators — define in a shell script:","Locale matrix: Before each screenshot set, switch locale:","Framing: Use screenshots or device_frame package to add device bezels, then composite with Fastlane's frameit or a custom script.","CI integration: On tagged commits, run the screenshot pipeline and upload to an artifact store. Fastlane deliver can submit to App Store Connect directly."]},{"l":"Shared Test Setup/Teardown","p":["Extract _Fake* classes from SDK test files into hostr_sdk/test/helpers/:","Create app-level test helpers in app/test/helpers/:","Use SeedPipeline in app tests — bridge the SDK's seed system into the app's TestRequests:"]},{"l":"Mock Relay vs Real Relay Strategy","p":["~95% (depends on Docker)","~99% deterministic","⚡ Fast","\uD83D\uDC0C Slow","\uD83D\uDD36 Medium","100% deterministic","Business logic, cubits, parsers","Data source","Default to TestRequests for all app tests (fast, deterministic)","Docker stack (./scripts/start_local.sh)","Escrow, swaps, on-chain, end-to-end","Full relay protocol, gift-wrap flow","Integration (mock)","Integration (real)","MockRelay (local WebSocket)","Reliability","Speed","Strategy:","Tag tests: @Tags(['unit']), @Tags(['integration']), @Tags(['e2e']) — run subsets in CI","Test type","TestRequests (in-memory)","UI rendering, interaction","Unit tests","Use for","Use MockRelay only when testing relay-specific behavior (subscription management, auth, reconnection)","Use real Docker stack only for escrow/swap integration tests and manual QA","Widget tests"]},{"l":"Execution Plan"},{"l":"Phase 1 — Foundation (Week 1)","p":["#","\uD83D\uDD34","\uD83D\uDFE0","\uD83D\uDFE2","1.1","1.2","1.3","1.4","1.5","1.6","1.7","1.8","15m","1h","2h","30m","Add kAnimationDurationFast constant","Create AppErrorWidget (replaces Placeholder() for image errors)","Create AppLoadingIndicator widget with .small()/.medium()/.large()","Create ErrorMapper service (exceptions → user-friendly strings)","Create showAppModal() helper with standard defaults","Define icon size constants (kIconXs–kIconHero)","Define spacing scale constants (kSpace0–kSpace8) + Gap widget","Estimated Effort","Extract _ShimmerSurface into reusable ShimmerPlaceholder","No visible UI changes, but enables everything else.","Priority","Task"]},{"l":"Phase 2 — Visual Consistency (Week 2)","p":["#","\uD83D\uDD34","\uD83D\uDFE0","\uD83D\uDFE1","\uD83D\uDFE2","1h","2.1","2.10","2.2","2.3","2.4","2.5","2.6","2.7","2.8","2.9","2h","30m","3h","4h","Add cached_network_image, wire into BlossomImage","Add shimmer placeholders to image loading and list loading","Estimated Effort","Extract remaining hardcoded strings to app_en.arb","Priority","Replace all CircularProgressIndicator with AppLoadingIndicator","Replace all ElevatedButton with FilledButton for primary CTAs","Replace all hardcoded fontSize: with textTheme.*","Replace all hardcoded icon sizes with kIcon* constants","Replace all hardcoded SizedBox spacing with Gap.*","Replace all showModalBottomSheet with showAppModal()","Replace hardcoded animation durations/curves with constants","Systematic sweep across all presentation files.","Task"]},{"l":"Phase 3 — Error Handling (Week 3)","p":["#","⛔","\uD83D\uDD34","\uD83D\uDFE0","\uD83D\uDFE1","1h","2h","3.1","3.2","3.3","3.4","3.5","3.6","3.7","3.8","30m","3h","4h","Add BlocListener-based error snackbars for transient errors","Add BlocObserver for global error/transition logging","Add try/catch + error state to ListCubit","Estimated Effort","Fix PayOperation — remove rethrow, don't close on failure","Integrate Sentry/Crashlytics in runZonedGuarded + FlutterError.onError","Priority","Show actual error details in swap failure UI","Standardize all cubit error states to sealed classes","Task","Wire CountCubitStateError emission"]},{"l":"Phase 4 — Performance & Protocol (Week 4)","p":["#","⛔","\uD83D\uDD34","\uD83D\uDFE0","\uD83D\uDFE1","1h","2h","3h","4.1","4.2","4.3","4.4","4.5","4.6","4.7","4.8","6h","Add v: 1 to all custom event content JSON","Enable cacheRead: true for query() in CrudUseCase","Estimated Effort","Fix kNostrKindEscrowService kind number (40021 → 3xxxx)","Fix N+1 in subscribeToMyReservations() — batch listing IDs","Implement NIP-45 COUNT if relays support it","Make all fromJson tolerant with ?? default fallbacks","Make parser error-resilient (skip malformed events, don't crash stream)","Multiplex trade subscriptions to reduce subscription count","Priority","Task"]},{"l":"Phase 5 — Test Infrastructure (Week 5)","p":["#","\uD83D\uDFE0","\uD83D\uDFE1","2h","3h","4h","5.1","5.2","5.3","5.4","5.5","5.6","5.7","5.8","Add golden image tests for key widgets","Add test tags (unit, integration, e2e) + CI configuration","Bridge SeedPipeline into app integration tests via TestRequests","Build EventMigrator for versioned event migration on app start","Create app/test/helpers/pump_app.dart for widget test bootstrapping","Create TestScenario framework for page-specific flutter drive tests","Estimated Effort","Extract shared _Fake* classes to hostr_sdk/test/helpers/","Implement device × locale screenshot matrix script","Priority","Task","Total estimated effort: ~85 hours across 5 phases. Phases 1–2 are visual and can be done in parallel with Phase 3 (error handling). Phase 4 (performance/protocol) should come after Phase 3 since error resilience is a prerequisite. Phase 5 (testing) can begin any time but benefits from having Phases 1–4 complete."]}],[{"l":"Hostr App Audit (Visual + Logic)","p":["Date: 2026-02-23 Scope: app/lib/presentation/**, key app cubits, and hostr_sdk/lib/** usecases/streams/payments/seeding.","This document is intentionally findings-only and plan-only (no code changes yet)."]},{"l":"Visual"},{"l":"1) Spacing system audit"},{"l":"Findings","p":["Spacing primitives are inconsistent across the UI:","SizedBox(...) used heavily in presentation (many raw literals like 4, 6, 8, 10, 12, 15, 16, 24, 40).","CustomPadding exists and already ties to kDefaultPadding, but is not consistently used.","Spacer() is used very little relative to manual fixed-width/fixed-height spacing.","Practical impact:","Visual rhythm changes between screens/components.","Harder to refactor density for compact/large form factors.","Increased cognitive noise from micro-inconsistencies."]},{"l":"Principle to adopt","p":["Use a single spacing scale derived from kDefaultPadding:","Example token map (recommended):","spaceXs = kDefaultPadding / 8","spaceSm = kDefaultPadding / 4","spaceMd = kDefaultPadding / 2","spaceLg = kDefaultPadding","spaceXl = kDefaultPadding * 1.5","Introduce 2 reusable widgets:","AppGap.h(multiplier) / AppGap.w(multiplier)","DefaultSpacer(multiplier) for flex layouts where proportional growth is desired."]},{"l":"Priority hotspots","p":["Listing/detail and profile widgets with many literal SizedBox values.","Payment flows and modal content where spacing currently mixes multiple scales."]},{"l":"2) Typography audit"},{"i":"findings-1","l":"Findings","p":["There are only a small number of explicit fontSize: overrides, but they are not tokenized.","Most text is theme-driven (good), but explicit overrides remain in profile/payment/reservation/search marker areas."]},{"l":"Best principle for font sizes","p":["Keep a small typographic set to reduce cognitive load:","Display (rare)","Title","Body","Label/Caption","In Flutter: prefer ThemeData.textTheme everywhere.","Avoid ad-hoc TextStyle(fontSize: X) unless the style is first registered as an app token/semantic style."]},{"l":"Recommended target","p":["90%+ of app text should use textTheme semantic roles.","Explicit size overrides only for exceptional UI (e.g., map marker rendering internals)."]},{"l":"3) Icons, icon buttons, bitmap pills"},{"i":"findings-2","l":"Findings","p":["Icon sizes are inconsistent (12, 14, 16, 18, 20, 30, 48, etc.) and not tokenized.","Icon button usage is mixed (sometimes icon-only where textual affordance would be clearer).","Price marker pills are custom-rendered and generally good, but text/icon sizing should align to typography tokens."]},{"l":"Principles","p":["Tokenize icon sizes: e.g. iconSm, iconMd, iconLg, iconXl.","Use icon-only buttons only when intent is universally obvious (close, copy, back, overflow).","Use icon+label for actions with consequence/ambiguity (fund, swap, escrow actions)."]},{"l":"4) Button hierarchy"},{"i":"findings-3","l":"Findings","p":["Multiple button types are used (FilledButton, ElevatedButton, OutlinedButton, TextButton, IconButton) with inconsistent semantics.","Some equivalent actions use different variants across screens."]},{"l":"Recommended hierarchy","p":["Primary: FilledButton (one per area/modal).","Secondary: OutlinedButton or FilledButton.tonal.","Tertiary: TextButton.","IconButton: utility actions only.","Define usage rules in a small design contract and enforce via component wrappers."]},{"l":"5) Animation consistency"},{"i":"findings-4","l":"Findings","p":["Global animation constants exist (kAnimationDuration, kAnimationCurve, kStaggerDelay) which is excellent.","Several widgets still use literal durations (200ms, 400ms, 1s, 1.5s, 2s, etc.)."]},{"l":"Principle","p":["One shared motion system:","Enter/exit duration","Emphasis duration","Debounce duration tokens","Shared curves","Any literal duration should be justified by domain behavior (polling/network timeout) not visual preference."]},{"l":"6) Modal style consistency"},{"i":"findings-5","l":"Findings","p":["You already have a reusable ModalBottomSheet component (strong foundation).","Many call-sites still directly invoke bottom sheets/dialogs with varying style density."]},{"i":"principle-1","l":"Principle","p":["Route all modal content through one modal shell component.","Keep title/subtitle/body/button zones identical across flows."]},{"l":"7) Perceived performance (preload + placeholders)"},{"i":"findings-6","l":"Findings","p":["You already preload listing images (ImagePreloader, PreloadListingImages) — this is good.","Some image states still use generic placeholders/progress indicators causing layout and perceived-jank differences.","Filter screen and some bottom sheets are built only on click; this can feel delayed when dependency graph is heavy."]},{"l":"Good practice guidance","p":["Preload expensive screens only when:","high-open-frequency,","high-build-cost,","no stale-data risk.","Use skeleton/fixed-size placeholders to prevent resizing jumps.","Keep dimensions stable during loading (especially media cards and carousels)."]},{"l":"8) Translation/i18n"},{"i":"findings-7","l":"Findings","p":["Localization support is present and used in many places.","There are still many hardcoded English strings in presentation and widget files."]},{"i":"principle-2","l":"Principle","p":["User-visible strings must go through localization layer.","Reserve inline literals for temporary debug/dev surfaces only."]},{"l":"Visual execution plan"},{"l":"Phase V1 — Design tokens + wrappers","p":["Add spacing/icon/typography/motion tokens in one source of truth.","Add wrapper components (AppGap, AppButton, AppModal, icon size helpers).","Document usage rules (short markdown spec)."]},{"l":"Phase V2 — Bulk refactor (safe mechanical)","p":["Replace raw SizedBox literals with spacing tokens/wrappers.","Replace ad-hoc fontSize with textTheme semantics.","Normalize icon sizes and button variants."]},{"l":"Phase V3 — Motion + modal normalization","p":["Replace visual literal durations with motion tokens.","Move bottom-sheet/dialog call sites to shared modal shell."]},{"l":"Phase V4 — UX polish/perf","p":["Add skeleton placeholders with fixed dimensions.","Pre-warm high-frequency entry screens (filters/payment chooser) where warranted.","Validate in Widgetbook + integration screenshots."]},{"l":"Visual acceptance criteria","p":["No raw visual spacing literals outside approved token helpers.","No ad-hoc font sizes outside tokenized typography styles.","All modal flows share same shell and button hierarchy.","Consistent animation timing across presentation layer."]},{"l":"Logic"},{"l":"1) High-load hotspots across app + sdk"},{"i":"findings-8","l":"Findings","p":["Potential heavy fan-out from per-item subscriptions in listing-related widgets.","Search map marker updates rebuild markers asynchronously and can churn under rapid list updates.","Requests.count() currently materializes full query results and counts in memory (can be expensive).","Some thread/message rebuild paths can become O(n^2)-ish for larger datasets."]},{"l":"Recommendation","p":["Move toward aggregate/list-level subscriptions instead of per-item network subscriptions.","Use batched updates and incremental diffing for maps/lists.","Prefer protocol/server count mechanisms where available; avoid toList().length for large streams."]},{"l":"2) Stream lifecycle + listener cleanup"},{"i":"findings-9","l":"Findings","p":["Many areas correctly cancel subscriptions on dispose/close.","However lifecycle policy is mixed (manual lists in some modules, takeUntil + dispose subject in others).","CrudUseCase owns a broadcast _updates controller but has no explicit dispose contract."]},{"l":"Best practice recommendation","p":["Standardize to one pattern per layer:","UI/cubits: maintain explicit subscription registry + deterministic close/dispose.","Reactive pipelines: takeUntil(_dispose$) for derived streams.","Every long-lived service with controllers/subjects should expose and be called with dispose().","Add leak tests for critical long-lived services."]},{"l":"3) Usecase correctness (CRUD/request batching/caching)"},{"i":"findings-10","l":"Findings","p":["CrudUseCase batching for getOne and findByTag is a strong pattern.","In-flight query dedup exists in Requests (good).","Potential correctness/perf pitfalls remain in edge cases:","fallback fan-out queries after unmatched batch requests,","broad filters causing high relay load,","non-uniform caching toggles."]},{"i":"recommendation-1","l":"Recommendation","p":["Introduce explicit query policy per usecase:","cache strategy,","timeout strategy,","retry policy,","dedupe key policy.","Add metrics counters for batched requests, fallback rate, and duplicate subscriptions."]},{"l":"4) Error handling (EntityCubit, payments/swaps, parser)"},{"i":"findings-11","l":"Findings","p":["Error states exist but are mostly untyped/stringly in several paths.","Payment/swap failures are surfaced but user messaging is not consistently actionable.","Nostr parser currently throws on malformed event parse path; one bad event can poison a stream path if not isolated."]},{"i":"recommendation-2","l":"Recommendation","p":["Adopt typed domain failures (network/validation/protocol/auth/retryable/non-retryable).","Add user-safe mapping layer from domain failures to UX copy + recovery action.","Parser strategy:","never crash broad stream on one malformed event,","emit parse failure telemetry,","quarantine invalid event and continue."]},{"l":"5) Nostr protocol future-proofing (immutability + migrations)"},{"i":"findings-12","l":"Findings","p":["Since Nostr events are signed/immutable, schema mistakes are costly."]},{"l":"Best-practice strategy","p":["Yes: add explicit protocol versioning in tags/content for your custom kinds.","Prefer additive evolution (new fields optional) before breaking changes.","On breaking changes:","support dual read (vN + vN+1) for a migration window,","write only latest version once app is upgraded,","optionally publish newly signed migrated events when user key is available.","Keep parser backward compatible and tolerant to unknown fields."]},{"l":"6) Test architecture: fake relay vs real local stack"},{"l":"Recommended strategy","p":["Use a layered test pyramid:","Fast deterministic unit tests with fake request transport (no relay).","Contract/integration tests with mock relay semantics (wipable state between tests).","End-to-end smoke tests against real local relay + anvil.","Each tier should share scenario fixtures and setup/teardown primitives."]},{"l":"7) Seed builder extensions for repeatable scenarios"},{"i":"findings-13","l":"Findings","p":["Seed pipeline and TestSeedHelper already provide a good foundation."]},{"l":"Recommended extension set","p":["Scenario DSL for explicit actor states:","user/listings/reservations/messages/payments/escrow statuses.","Deterministic IDs and named fixtures per scenario.","Snapshot seed packs for “open this exact page in exact state”.","Shared setup/teardown API used by widget tests, integration tests, and screenshot runs."]},{"l":"8) Widgetbook/page targeting + screenshot automation"},{"l":"For specific page + specific seed data","p":["Yes, you can run app-level integration tests that:","bootstrap deterministic seed scenario,","deep-link directly to target route,","wait for settled state,","capture screenshot."]},{"l":"For app-store screenshot pipeline","p":["Add dedicated screenshot scenario suite with stable mock/network assets.","Generate named outputs per device/locale/theme.","Make CI artifact upload + review part of PR workflow."]},{"l":"Logic execution plan"},{"l":"Phase L1 — Observability + contracts","p":["Define typed failure model and error mapping matrix.","Add instrumentation for subscription counts, batch hit rate, fallback rate, parse failures.","Add lifecycle ownership map for long-lived streams/controllers."]},{"l":"Phase L2 — Reliability hardening","p":["Standardize stream disposal pattern per layer.","Add malformed-event tolerance in parser pipeline.","Add actionable error UX for Entity/Payment/Swap flows."]},{"l":"Phase L3 — Performance and protocol hardening","p":["Reduce per-item subscription fan-out where possible.","Optimize query/count paths and map/list churn.","Introduce explicit event versioning policy + migration playbook."]},{"l":"Phase L4 — Testing + screenshots","p":["Build reusable scenario fixtures on top of seed pipeline.","Split test suites by fake/mock/real tiers.","Add deterministic screenshot runner + CI artifacts."]},{"l":"Logic acceptance criteria","p":["No known long-lived subscription leaks in smoke lifecycle tests.","Parse failures are isolated and observable, not app-fatal.","Payment/swap/domain errors map to clear user recovery actions.","Deterministic scenario seeds can reproduce target pages for tests/screenshots."]},{"l":"Suggested rollout order (combined)","p":["Token foundations (visual) + failure taxonomy (logic).","Mechanical UI consistency refactor + parser/lifecycle hardening.","Seed scenario DSL + screenshot CI.","Protocol versioning rollout + migration tooling."]},{"l":"Notes","p":["This report intentionally avoids direct code edits.","Next step can be an implementation PR plan with concrete file-by-file changes and staged commits."]}]]