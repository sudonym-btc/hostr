x-templates:
  lnd-base: &lnd-base
    image: lightninglabs/lnd:v0.20.0-beta
    user: "0:0"
    depends_on:
      hostrbitcoind:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'lncli --network=regtest --rpcserver=localhost:${LIGHTNING_RPC_PORT} --macaroonpath=/lnd/data/chain/bitcoin/regtest/admin.macaroon --tlscertpath=/lnd/tls.cert getinfo | grep ''"block_height":'' || exit 1',
        ]
      interval: 1s
      timeout: 1s
      retries: 100
      start_period: 0s
    entrypoint:
      - sh
      - -lc
    command:
      - exec lnd --alias=Alby --tlsextradomain=lnd1 --tlsextradomain=lnd2 --lnddir=/lnd --datadir=/lnd --adminmacaroonpath=/lnd/data/chain/bitcoin/regtest/admin.macaroon --tlscertpath=/lnd/tls.cert --tlskeypath=/lnd/tls.key --noseedbackup --rpclisten=0.0.0.0:${LIGHTNING_RPC_PORT} --restlisten=0.0.0.0:${LIGHTNING_REST_PORT} --tlsextraip=0.0.0.0 --bitcoin.regtest --bitcoin.node=bitcoind --bitcoind.rpchost=${BITCOIN_HOST}:${BITCOIN_RPC_PORT} --bitcoind.rpcuser=${BITCOIN_RPC_USER} --bitcoind.rpcpass=${BITCOIN_RPC_PASSWORD} --bitcoind.zmqpubrawtx=tcp://${BITCOIN_HOST}:${BITCOIN_ZMQ_TX_PORT} --bitcoind.zmqpubrawblock=tcp://${BITCOIN_HOST}:${BITCOIN_ZMQ_BLOCK_PORT}
    networks:
      - default
      - shared_network

  albyhub-base: &albyhub-base
    platform: linux/amd64
    depends_on:
      lnd1:
        condition: service_healthy
      relay:
        condition: service_healthy
      nginx-proxy:
        condition: service_healthy
    image: ghcr.io/getalby/hub:latest
    networks:
      - default

services:
  # ── TLS Certificate Authority (dev) ──────────────────────────────
  # Generates a root CA and per-service certificates signed by it.
  # In production, replace with Let's Encrypt via acme-companion.
  tls-init:
    image: alpine:3.20
    volumes:
      - ./docker/certs:/certs
      - ./docker/tls/ca:/ca
      - ./docker/tls:/scripts:ro
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: ["sh", "/scripts/generate-dev-certs.sh"]
    restart: "no"

  nginx-proxy:
    image: jwilder/nginx-proxy
    depends_on:
      tls-init:
        condition: service_completed_successfully
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./docker/certs:/etc/nginx/certs:ro
      - ./docker/vhost.d:/etc/nginx/vhost.d
      - ./docker/nginx-proxy.conf:/etc/nginx/conf.d/zzz_upload.conf:ro
    environment:
      - ENABLE_WEBSOCKETS=true
    healthcheck:
      test: ["CMD-SHELL", "nginx -t 2>/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 3s
    networks:
      default:
        aliases:
          - relay.${DOMAIN}
          - blossom.${DOMAIN}
          - lnbits1.${DOMAIN}
          - lnbits2.${DOMAIN}
          - alby1.${DOMAIN}
          - alby2.${DOMAIN}
          - landing.${DOMAIN}
          - ${DOMAIN}

  # NOSTR Relay
  relay:
    container_name: relay
    image: scsibug/nostr-rs-relay:latest
    platform: linux/amd64
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'timeout 2 bash -c ''exec 3<>/dev/tcp/127.0.0.1/80; printf "GET / HTTP/1.1\r\nHost: localhost\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==\r\nSec-WebSocket-Version: 13\r\n\r\n" >&3; head -1 <&3'' | grep -q 101',
        ]
      interval: 30m
      timeout: 3s
      retries: 30
      start_period: 10s
      start_interval: 2s
    environment:
      - VIRTUAL_HOST=relay.${DOMAIN}
      - VIRTUAL_PORT=80
      - ENABLE_WEBSOCKETS=true
      - HTTPS_METHOD=noredirect
      - RUST_LOG=debug
      - nostr_rs_relay=debug
    ports:
      - "${RELAY_PORT}:80"
    volumes:
      - ./docker/relay.toml:/usr/src/app/config.toml
      - ./docker/data/relay:/usr/src/app/db
    networks:
      - default
    profiles:
      - local
      - test
      - staging
      - prod

  # Nostr Blossom file server
  blossom:
    container_name: blossom
    image: ghcr.io/hzrd149/blossom-server:latest
    platform: linux/amd64
    environment:
      - VIRTUAL_HOST=blossom.${DOMAIN}
      - VIRTUAL_PORT=3000
    ports:
      - "3001:3000"
    volumes:
      - ./docker/blossom.yaml:/app/config.yml
      - ./docker/data/blossom:/app/data
    networks:
      - default
    profiles:
      - local
      - test
      - staging
      - prod

  landing-page:
    platform: linux/amd64
    build:
      context: ./landing-page
      dockerfile: Dockerfile
    environment:
      - VIRTUAL_HOST=landing.${DOMAIN}
      - VIRTUAL_PORT=80
      - VIRTUAL_HOST=${DOMAIN}
    ports:
      - "${LANDING_PAGE_PORT:-8091}:80"
    networks:
      - default
    profiles:
      - local
      
  # Escrow client which watches nostr & chain to facilitate escrow transactions
  escrow-contract-deploy:
    image: node:22-alpine
    depends_on:
      bootstrap:
        condition: service_completed_successfully
      anvil:
        condition: service_healthy
    working_dir: /workspace/escrow/contracts
    volumes:
      - ./:/workspace
      - ./docker/data/escrow:/data
    environment:
      - RPC_URL=http://anvil:8545
    command:
      [
        "sh",
        "-lc",
        "set -euo pipefail && npm ci --no-audit --no-fund && printf 'y\n' | npm exec -- hardhat ignition deploy ignition/modules/Escrow.ts --network localhost && ADDRESS=$$(node -e \"const fs=require('fs');const p='ignition/deployments/chain-33/deployed_addresses.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));const k=Object.keys(j).find((x)=>x.toLowerCase().includes('multiescrow'));if(!k){process.exit(2)};process.stdout.write(String(j[k]||''));\") && test -n \"$$ADDRESS\" && echo \"$$ADDRESS\" > /data/contract_addr && echo \"Escrow contract deployed at $$ADDRESS\"",
      ]
    restart: "no"
    profiles:
      - test
      - local

  escrow:
    build:
      context: .
      dockerfile: escrow/Dockerfile
    depends_on:
      escrow-contract-deploy:
        condition: service_completed_successfully
      anvil:
        condition: service_healthy
      nginx-proxy:
        condition: service_healthy
    environment:
      - NOSTR_RELAY=wss://relay.${DOMAIN}
      - PRIVATE_KEY=a9cbe715ebaeb852bf7cc3d35f4a81b9a58f16705e4bb8434aa453093e612206
      - RPC_URL=http://anvil:8545
    volumes:
      - ./docker/data/escrow:/data:ro
      - ./docker/tls/ca/ca.crt:/tls/ca.crt:ro
    command:
      [
        "sh",
        "-lc",
        "cp /tls/ca.crt /usr/local/share/ca-certificates/hostr-dev-ca.crt && update-ca-certificates 2>/dev/null && set -euo pipefail && export CONTRACT_ADDR=$$(cat /data/contract_addr) && exec dart run lib/cli.dart start",
      ]
    networks:
      - default
      - shared_network
    profiles:
      - test
      - local

  # Shared bitcoin node
  hostrbitcoind:
    container_name: hostrbitcoind
    image: bitcoin/bitcoin
    healthcheck:
      test:
        [
          "CMD",
          "bitcoin-cli",
          "-regtest",
          "-rpcuser=bitcoin",
          "-rpcpassword=bitcoin",
          "-rpcport=18888",
          "getblockchaininfo",
        ]
      timeout: 1s
      retries: 10
      interval: 1s
      start_period: 0s
    command:
      [
        "bitcoind",
        "-port=${BITCOIN_PORT}",
        "-addnode=boltz-bitcoind:18444",
        "-txindex=1",
        "-onlynet=ipv4",
        "-regtest=1",
        "-rpcport=${BITCOIN_RPC_PORT}",
        "-rpcuser=${BITCOIN_RPC_USER}",
        "-rpcpassword=${BITCOIN_RPC_PASSWORD}",
        "-rpcallowip=0.0.0.0/0",
        "-rpcbind=0.0.0.0",
        "-zmqpubrawtx=tcp://0.0.0.0:${BITCOIN_ZMQ_TX_PORT}",
        "-zmqpubrawblock=tcp://0.0.0.0:${BITCOIN_ZMQ_BLOCK_PORT}",
        "-zmqpubhashblock=tcp://0.0.0.0:${BITCOIN_ZMQ_BLOCK_PORT}",
      ]
    ports:
      - "${BITCOIN_PORT}:${BITCOIN_PORT}"
      - "${BITCOIN_RPC_PORT}:${BITCOIN_RPC_PORT}"
    volumes:
      - ./docker/data/bitcoin:/home/bitcoin/.bitcoin
    networks:
      - default
      - shared_network
    profiles:
      - local
      - test

  lnd1:
    <<: *lnd-base
    ports:
      - "12209:8080"
      - "12219:8081"
    volumes:
      - ./docker/data/lightning_data/1:/lnd
    profiles:
      - local
      - test

  lnd2:
    <<: *lnd-base
    ports:
      - "12210:8080"
      - "12220:8081"
    volumes:
      - ./docker/data/lightning_data/2:/lnd
    profiles:
      - local
      - test

  lnbits1:
    image: lnbits/lnbits:v1.4.2
    depends_on:
      lnd1:
        condition: service_healthy
    ports:
      - "${LNBITS_1_PORT}:5000"
    environment:
      - VIRTUAL_HOST=lnbits1.${DOMAIN}
      - VIRTUAL_PORT=5000
      - LNBITS_ADMIN_UI=true
      - LNBITS_BACKEND_WALLET_CLASS=LndRestWallet
      - LND_REST_ENDPOINT=https://lnd1:${LIGHTNING_REST_PORT}
      - LND_REST_CERT=/app/lnd/tls.cert
      - LND_REST_MACAROON=/app${LND_ADMIN_MACAROON_PATH}
      - LNBITS_ADMIN_EXTENSIONS="lnurlp,nostrnip5"
      - LNBITS_USER_DEFAULT_EXTENSIONS="lnurlp,nostrnip5"
      - LNBITS_EXTENSIONS_DEFAULT_INSTALL="lnurlp,nostrnip5"

    volumes:
      - ./docker/data/lightning_data/1:/app/lnd
      - ./docker/data/lnbits/1:/app/data
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -lc '</dev/tcp/127.0.0.1/5000'"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s
    networks:
      - default
    profiles:
      - local
      - test

  lnbits2:
    image: lnbits/lnbits:v1.4.2
    depends_on:
      lnd2:
        condition: service_healthy
    ports:
      - "${LNBITS_2_PORT}:5000"
    environment:
      - VIRTUAL_HOST=lnbits2.${DOMAIN}
      - VIRTUAL_PORT=5000
      - LNBITS_ADMIN_UI=true
      - LNBITS_BACKEND_WALLET_CLASS=LndRestWallet
      - LND_REST_ENDPOINT=https://lnd2:${LIGHTNING_REST_PORT}
      - LND_REST_CERT=/app/lnd/tls.cert
      - LND_REST_MACAROON=/app${LND_ADMIN_MACAROON_PATH}
      - LNBITS_ADMIN_EXTENSIONS="lnurlp,nostrnip5"
      - LNBITS_USER_DEFAULT_EXTENSIONS="lnurlp,nostrnip5"
      - LNBITS_EXTENSIONS_DEFAULT_INSTALL="lnurlp,nostrnip5"

    volumes:
      - ./docker/data/lightning_data/2:/app/lnd
      - ./docker/data/lnbits/2:/app/data
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -lc '</dev/tcp/127.0.0.1/5000'"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s
    networks:
      - default
    profiles:
      - local
      - test

  albyhub1:
    <<: *albyhub-base
    depends_on:
      lnd1:
        condition: service_healthy
      nginx-proxy:
        condition: service_healthy
    volumes:
      - ./docker/data/lightning_data/1:/lnd
      - ./docker/data/albyhub:/data
      - ./docker/tls/ca/ca-bundle.crt:/tls/ca-bundle.crt:ro
    environment:
      - VIRTUAL_HOST=alby1.${DOMAIN}
      - VIRTUAL_PORT=8080
      - RELAY=wss://relay.${DOMAIN}
      - SSL_CERT_FILE=/tls/ca-bundle.crt
      - AUTO_UNLOCK_PASSWORD=Testing123!
      - LOG_EVENTS=true
      - LN_BACKEND_TYPE=LND
      - LND_MACAROON_FILE=${LND_ADMIN_MACAROON_PATH}
      - LND_ADDRESS=lnd1:${LIGHTNING_RPC_PORT}
      - WORK_DIR=data/1
    ports:
      - "${ALBYHUB_1_PORT}:8080"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -lc '</dev/tcp/127.0.0.1/8080'"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s
    profiles:
      - local
      - test

  albyhub2:
    <<: *albyhub-base
    depends_on:
      lnd2:
        condition: service_healthy
      nginx-proxy:
        condition: service_healthy
    volumes:
      - ./docker/data/lightning_data/2:/lnd
      - ./docker/data/albyhub:/data
      - ./docker/tls/ca/ca-bundle.crt:/tls/ca-bundle.crt:ro
    environment:
      - VIRTUAL_HOST=alby2.${DOMAIN}
      - VIRTUAL_PORT=8080
      - RELAY=wss://relay.${DOMAIN}
      - SSL_CERT_FILE=/tls/ca-bundle.crt
      - LOG_EVENTS=true
      - LN_BACKEND_TYPE=LND
      - LND_MACAROON_FILE=${LND_ADMIN_MACAROON_PATH}
      - LND_ADDRESS=lnd2:${LIGHTNING_RPC_PORT}
      - WORK_DIR=data/2
    ports:
      - "${ALBYHUB_2_PORT}:8080"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -lc '</dev/tcp/127.0.0.1/8080'"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s
    profiles:
      - local
      - test

  bootstrap:
    image: docker:27-cli
    depends_on:
      relay:
        condition: service_healthy
      hostrbitcoind:
        condition: service_healthy
      lnd1:
        condition: service_healthy
      lnd2:
        condition: service_healthy
    volumes:
      - ./:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    environment:
      - LNBITS_HOST=host.docker.internal
    command:
      [
        "sh",
        "-lc",
        "apk add --no-cache bash jq curl >/dev/null && bash /workspace/scripts/bootstrap_local_test.sh",
      ]
    restart: "no"
    profiles:
      - local
      - test

  unlock-alby-lnbits:
    image: dart:3.10.8
    depends_on:
      lnbits1:
        condition: service_healthy
      lnbits2:
        condition: service_healthy
      albyhub1:
        condition: service_healthy
      albyhub2:
        condition: service_healthy
      nginx-proxy:
        condition: service_healthy
    volumes:
      - ./:/workspace:ro
      - ./docker/tls/ca/ca.crt:/tls/ca.crt:ro
    working_dir: /workspace/hostr_sdk
    environment:
      - LNBITS_1_URL=https://lnbits1.${DOMAIN}
      - LNBITS_2_URL=https://lnbits2.${DOMAIN}
      - ALBYHUB_1_URL=https://alby1.${DOMAIN}
      - ALBYHUB_2_URL=https://alby2.${DOMAIN}
      - LNBITS_ADMIN_EMAIL=${LNBITS_ADMIN_EMAIL}
      - LNBITS_ADMIN_PASSWORD=${LNBITS_ADMIN_PASSWORD}
      - LNBITS_EXTENSION_NAME=${LNBITS_EXTENSION_NAME}
      - LNBITS_NOSTR_PRIVATE_KEY=${LNBITS_NOSTR_PRIVATE_KEY}
      - ALBYHUB_PASSWORD=${ALBYHUB_PASSWORD}
    command:
      [
        "sh",
        "-lc",
        "cp /tls/ca.crt /usr/local/share/ca-certificates/hostr-dev-ca.crt && update-ca-certificates 2>/dev/null && /usr/lib/dart/bin/dart --version && rm -rf /tmp/workspace && cp -a /workspace /tmp/workspace && cd /tmp/workspace/hostr_sdk && /usr/lib/dart/bin/dart pub get && /usr/lib/dart/bin/dart run bin/setup_lightning.dart",
      ]
    restart: "no"
    profiles:
      - local
      - test

  seed-relay:
    image: dart:stable
    depends_on:
      relay:
        condition: service_healthy
      bootstrap:
        condition: service_completed_successfully
      nginx-proxy:
        condition: service_healthy
    volumes:
      - ./:/workspace
      - ./docker/tls/ca/ca.crt:/tls/ca.crt:ro
    working_dir: /workspace/hostr_sdk
    command: >
      bash -lc "cp /tls/ca.crt /usr/local/share/ca-certificates/hostr-dev-ca.crt && update-ca-certificates 2>/dev/null &&
      dart pub get &&
      dart run bin/seed.dart
      --config-json='{\"relayUrl\":\"wss://relay.${DOMAIN}\",\"rpcUrl\":\"http://anvil:8545\",\"fundProfiles\":false}'"
    restart: "no"
    profiles:
      - seed

volumes:
  bitcoind:
  lightning_data:

networks:
  default:
    driver: bridge
  shared_network:
    external: true
