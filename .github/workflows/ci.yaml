name: CI

on: [push, pull_request]

jobs:
  sdk: 
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: '3.10.8'

      - run: dart --version

      - name: Cache Dart dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            app/.dart_tool
          key: ${{ runner.os }}-dart-${{ hashFiles('app/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-dart-
      - name: Install dependencies
        run: dart pub get
        working-directory: hostr_sdk

      - name: Start test stack
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
        run: ./scripts/restart.sh test

      - name: Debug stack startup failure
        if: failure()
        run: |
          docker compose ps -a || true
          docker compose logs --no-color hostrbitcoind lnd1 lnd2 bootstrap escrow-contract-deploy || true
          docker compose logs --no-color bitcoind-init lnd-1 lnd-2 regtest-start boltz-backend || true

      - name: Run tests
        run: dart test --coverage
        working-directory: hostr_sdk
      # test_coverage package outdated
      # - name: Check coverage
      #   run: |
      #     COVERAGE=$(dart pub run test_coverage)   

      - name: Stop test stack
        if: always()
        run: docker compose down --remove-orphans --volumes
  app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.41.1

      - run: flutter --version

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            app/.dart_tool
            app/widgetbook_workspace/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('app/pubspec.yaml', 'app/widgetbook_workspace/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get
        working-directory: app

      - name: Build Widgetbook
        run: |
          flutter pub get
          flutter build web --no-wasm-dry-run
        working-directory: app/widgetbook_workspace

      - name: Run tests
        run: flutter test --coverage
        working-directory: app

        # test_coverage package outdated
      # - name: Check coverage
      #   run: |
      #     COVERAGE=$(flutter pub run test_coverage)
      #     THRESHOLD=80
      #     if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
      #       echo "Code coverage ($COVERAGE%) is below the threshold ($THRESHOLD%)."
      #       exit 1
      #     fi
      #   working-directory: app

      # not able to find free codecov for shield icon generation
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     files: ./app/coverage/lcov.info
      #     token: ${{ secrets.CODECOV_TOKEN }}
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
      - name: Install dependencies
        run: npm clean-install
      - name: Install semantic-release/exec
        run: npm install --save-dev @semantic-release/exec
      - name: Verify the integrity of provenance attestations and registry signatures for installed dependencies
        run: npm audit signatures
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --dry-run
