name: CI

on:
  push:
    branches: [main, next]
  pull_request:

jobs:
  # ── 1. Detect which submodules changed ─────────────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      docker_root: ${{ steps.filter.outputs.docker_root }}
      sdk: ${{ steps.filter.outputs.sdk }}
      app: ${{ steps.filter.outputs.app }}
      escrow: ${{ steps.filter.outputs.escrow }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docker_root:
              - 'docker-compose*.yml'
              - 'docker/**'
              - 'scripts/**'
              - 'Dockerfile'
              - '.dockerignore'
              - '.env'
              - '.env.*'
              - '**/.env'
              - '**/.env.*'
            sdk:
              - 'hostr_sdk/**'
              - 'models/**'
              - '.github/workflows/ci.yaml'
            app:
              - 'app/**'
              - 'hostr_sdk/**'
              - 'models/**'
              - '.github/workflows/ci.yaml'
            escrow:
              - 'escrow/**'
              - 'hostr_sdk/**'
              - '.github/workflows/ci.yaml'

  # ── 2. hostr_sdk tests (unit + Docker integration) ─────────────────────────
  test_sdk:
    name: Test — hostr_sdk
    needs: changes
    if: needs.changes.outputs.sdk == 'true' || needs.changes.outputs.docker_root == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: '3.10.8'

      - run: dart --version

      - name: Cache Dart dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            hostr_sdk/.dart_tool
          key: ${{ runner.os }}-dart-${{ hashFiles('hostr_sdk/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-dart-

      - name: Install dependencies
        run: dart pub get
        working-directory: hostr_sdk

      - name: Run unit tests
        run: dart test test/unit -t unit
        working-directory: hostr_sdk

      - name: Start test stack
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
        run: ./scripts/restart.sh test

      - name: Debug stack startup failure
        if: failure()
        run: |
          docker compose ps -a || true
          docker compose logs --no-color hostrbitcoind lnd1 lnd2 bootstrap escrow-contract-deploy || true

      - name: Add host aliases
        run: |
          echo "127.0.0.1 relay.hostr.development blossom.hostr.development alby1.hostr.development alby2.hostr.development lnbits1.hostr.development lnbits2.hostr.development" | sudo tee -a /etc/hosts

      - name: Run Docker integration tests
        run: dart test test/integration -t docker
        working-directory: hostr_sdk

      - name: Stop test stack
        if: always()
        run: docker compose down --remove-orphans --volumes

  # ── 3. Flutter app tests ────────────────────────────────────────────────────
  test_app:
    name: Test — app
    needs: changes
    if: needs.changes.outputs.app == 'true' || needs.changes.outputs.docker_root == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: '3.41.1'

      - run: flutter --version

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            app/.dart_tool
            app/widgetbook_workspace/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('app/pubspec.yaml', 'app/widgetbook_workspace/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get
        working-directory: app

      - name: Run tests
        run: flutter test --coverage
        working-directory: app

      - name: Build Widgetbook (compile check)
        run: |
          flutter pub get
          flutter build web --no-wasm-dry-run
        working-directory: app/widgetbook_workspace

  # ── 4. Escrow daemon checks ───────────────────────────────────────────────
  test_escrow:
    name: Test — escrow
    needs: changes
    if: needs.changes.outputs.escrow == 'true' || needs.changes.outputs.docker_root == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: '3.10.8'

      - run: dart --version

      - name: Cache Dart dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            escrow/.dart_tool
          key: ${{ runner.os }}-dart-escrow-${{ hashFiles('escrow/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-dart-escrow-

      - name: Install dependencies
        run: dart pub get
        working-directory: escrow

      - name: Analyze (compile check)
        run: dart analyze
        working-directory: escrow

  # ── 5. Quality gate — blocks release if any required test failed ────────────
  # Jobs that were skipped (no changes) are treated as passing.
  quality_gate:
    name: Quality Gate
    needs: [test_sdk, test_app, test_escrow]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          sdk="${{ needs.test_sdk.result }}"
          app="${{ needs.test_app.result }}"
          escrow="${{ needs.test_escrow.result }}"
          failed=()
          for entry in "sdk:$sdk" "app:$app" "escrow:$escrow"; do
            name="${entry%%:*}"
            result="${entry##*:}"
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              failed+=("$name")
            fi
          done
          if [[ ${#failed[@]} -gt 0 ]]; then
            echo "❌ Failed jobs: ${failed[*]}"
            exit 1
          fi
            echo "✅ Quality gate passed (sdk=$sdk, app=$app, escrow=$escrow)"

          # ── 6. Semantic release (main only, after gate passes) ─────────────────────
  release:
    name: Release
    needs: quality_gate
    if: >
      needs.quality_gate.result == 'success' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm clean-install

      - name: Install semantic-release/exec
        run: npm install --save-dev @semantic-release/exec

      - name: Verify provenance attestations
        run: npm audit signatures

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
